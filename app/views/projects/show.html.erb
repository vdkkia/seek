<%= render :partial => "general/item_title",:locals => {:item=>@project, :buttons_partial => 'projects/buttons'} %>
<div>
  <div class="col-lg-2"></div>
  <div class="col-lg-8">
    <%= hidden_field_tag 'selected_item_id', ''  %>
    <%= hidden_field_tag 'selected_item_type', ''  %>
    <%= hidden_field_tag 'selected_folder', ''  %>
    <%= hidden_field_tag 'selected_tree_item_id', ''  %>
    <%= hidden_field_tag 'selected_std_asy', ''  %>

  </div>
  <div class="col-lg-2"></div>
</div>
<div class="row">
  <div class="col-md-12  box_about_actor">
    <div class="row">
      <div class="col-md-7">
        <ul class="bcrumb">
          <li><a href="#">Project</a></li>
          <li style="display:none"><a href="#">Investigation</a></li>
          <li style="display:none"><a href="#">Study</a></li>
          <li style="display:none"><a href="#">Assay</a></li>
        </ul>
      </div>
      <div class="col-md-5" style="text-align:right">
        <div>
          <input id="btn_delete_item" type="button" class="btn btn-primary" value="Delete" onclick="deleteItem()" />
        </div>
      </div>
    </div>
    <div class="row">
      <div class=col-lg-3>
        <div id="treeview" class="col-lg-12 project_treeview">
          <div id="html" class="demo"></div>
        </div>
      </div>
      <div class="col-lg-9">
        <div style="padding:10px;background-color: aliceblue;border-radius: 5px; border: #ddd 1px solid">
          <div id="container" class="container-fluid">
            <div id="projectDetailContainer" class="row">
              <div class="col-lg-8 simpleForm">
                <%= render :partial => "project_details" -%>
              </div>
              <div class="col-lg-4">
                <%= render :partial => "layouts/contribution_section_box_avatar", :locals => { :object => @project } -%>
                <% if @project.can_manage? %>
                <%= render :partial => 'general/storage_usage_box', locals: { programme: @project,
                                                                    url: storage_report_project_path(@project)} %>
                <% end %>
              </div>
            </div>


            <div id="fileManagerContainer" class="row">
              <%= render :partial => "filemanager" -%>
            </div>

            <div id="investigationContainer" class="row">

              <%= render :partial => "investigation_details" -%>

            </div>
            <div id="studyContainer" class="row">
              <%= render :partial => "study" -%>
            </div>
            <div id="assayContainer" class="row">
              <%= render :partial => "assay" -%>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% if Seek::Config.project_hierarchy_enabled && logged_in_and_member? -%>
    <div style="clear:both;">
      <b>
        Project Hierarchies
        (<%= link_to "hide", '#', id: 'project-hierarchy-toggle' -%>):
      </b>
      <br />
      <br />
      <div id="project_hierarchy">
        <ul>
          <%= Rails.cache.fetch([:project_tree_editor, @project.cache_key]) { tree_editor_display Project, false, false, @project.id, "Person", true, true } %>
        </ul>
      </div>
    </div>
    <br />
    <div style="clear:both;">
      <b>
        <%= t('project') %> Members
        (<%= link_to "show", '#', id: 'project-hierarchy-members-toggle' %>):
      </b>
      <br />
      <br />
      <div id="project_mailing_list" style="display: none;">
        <%= project_mailing_list @project %>
      </div>
    </div>
    <% end %>
    <% if false%>
    <%# get, classify and authorize all assets for this project -%>
    <%= render :partial=>"general/items_related_to",:object => @project %>
    <%end%>
    <% if request_project_membership_button_enabled?(@project) %>
    <%= render partial: 'request_membership_form', locals: { project: @project } %>
    <% end %>
  </div>
</div>

<div class="modal" tabindex="-1" role="dialog" id="data-file-modal-inv">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <%= render :partial=>"investigations/new" %>
        <div class="row" style="padding:15px">
          <a id="submit_investigation" type="button" class="btn btn-primary">Create</a>
          &nbsp;
          <a type="button" class="btn btn-default">Cancel</a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal" tabindex="-1" role="dialog" id="data-file-modal-std">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <%= render :partial=>"studies/new" %>
        <div class="row" style="padding:15px">
          <a id="submit_study" type="button" class="btn btn-primary">Create</a>
          &nbsp;
          <a type="button" class="btn btn-default">Cancel</a>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="arrow_box" style="padding:5px; display:none; z-index:999; position:absolute">
  <ul id="preDefinedList" class="fadeout"
    style="list-style-type: none;padding:0;max-height:300px;overflow-y: scroll;margin:0">
    <li>
      <div class="input-group">
        <input placeholder="column name..." class="form-control customCol" />
        <span class="input-group-btn">
          <input id="btn_custom_col" class="btn btn-primary" type="button" value="Insert" onClick="">
        </span>
      </div>
    </li>
  </ul>
</div>
<script>
  $j('#project-hierarchy-toggle').click(function () {
    var el = $j('#project_hierarchy');

    if (el[0].style.display === 'none') {
      el.fadeIn();
      $j(this).text('hide');
    } else {
      el.fadeOut();
      $j(this).text('show');
    }

    return false;
  });

  $j('#project-hierarchy-members-toggle').click(function () {
    var el = $j('#project_mailing_list');

    if (el[0].style.display === 'none') {
      el.fadeIn();
      $j(this).text('hide');
    } else {
      el.fadeOut();
      $j(this).text('show');
    }

    return false;
  });
</script>

<script>
  (function ($, undefined) {
    "use strict";
    $j.jstree.plugins.separate = function (options, parent) {
      this.redraw_node = function (obj, deep, callback, force_draw) {
        obj = parent.redraw_node.apply(this, arguments);
        var n = this.get_node(obj),
          d = document;
        if (obj) {
          if (n.original.count) {
            obj.childNodes[1].innerHTML += " <span class='badge badge-secondary'>" + n.original.count +
              "</span>"
          }
          if (n.original._type) $j(obj.childNodes[1]).attr('_type', n.original._type)
          if (n.original._id) $j(obj.childNodes[1]).attr('_id', n.original._id)
          if (n.state.separate) {
            let p = d.createElement('p')
            p.innerHTML = n.state.separate.label;
            p.className = 'separator';
            if (n.state.separate.action) {
              let a = d.createElement('a')
              a.href = n.state.separate.action;
              a.className = 'treeaction glyphicon glyphicon-plus';
              $j(a).attr('onclick', `add${n.state.separate.label}(this)`)
              obj.prepend(a)

            }
            obj.prepend(p);
          }
        }
        return obj;
      };
    }
  })(jQuery);

  let pid, uid, std_id, inv_id, asy_id
  let acSource = {}
  let GSource = {}
  let AssayDetails = []
  var tbl_response_variables //saving this for resetting table cols
  $j(document).ready(function () {
    pid = <%= params[:id] %>
    uid = <%= current_user.id if current_user %>
    hide_all_containers()
    $j("#projectDetailContainer").show()
    get_project()
    init_workflow()
    $j("a:contains('Cancel')").click(function (e) {
      e.preventDefault();
      $j('#data-file-modal-inv').modal('hide');
      $j('#data-file-modal-std').modal('hide');
    })
    $j("#submit_investigation").click(function () {
      data = {
        "data": {
          "type": "investigations",
          "attributes": {
            "title": $j("#investigation_title").val(),
            "policy": {
              "access": "download",
              "permissions": [{
                "resource": {
                  "id": pid,
                  "type": "projects"
                },
                "access": "manage"
              }]
            },
            "description": $j("#investigation_description").val()
          },
          "relationships": {
            "projects": {
              "data": [{
                "id": pid,
                "type": "projects"
              }]
            },
            "publications": {
              "data": []
            },
            "creators": {
              "data": [{
                "id": uid,
                "type": "people"
              }]
            }
          }
        }
      }
      $j.ajax({
        method: 'POST',
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        cache: false,
        url: '/investigations',
        data: JSON.stringify(data),
        success: s => {
          location.reload(true);
        },
        error: (e) => {
          console.log('error creating investigation!')
        }
      })
    })

    $j("#submit_study").click(function () {
      let data = {
        "data": {
          "type": "studies",
          "attributes": {
            "title": $j("#study_title").val(),
            "description": $j("#study_description").val(),
            "policy": {
              "access": "download",
              "permissions": [{
                "resource": {
                  "id": pid,
                  "type": "projects"
                },
                "access": "manage"
              }]
            }
          },
          "relationships": {
            "investigation": {
              "data": {
                "id": $j("#selected_item_id").val(),
                "type": "investigations"
              }
            },
            "publications": {
              "data": []
            },
            "creators": {
              "data": [{
                "id": uid,
                "type": "people"
              }]
            }
          }
        }
      }
      $j.ajax({
        method: 'POST',
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        cache: false,
        url: '/studies',
        data: JSON.stringify(data),
        success: s => {
          console.log('study created successfully!')
          location.reload(true);
        },
        error: (e) => {
          console.log('error creating study!')
        }
      })
    })

    $j("#btn_save_workflow").on("click", function () {
      SAVE()
    });

    tbl_response_variables = $j('.tbl_response_variables').html()
    $j('.design_chk').change(function () {
      $j(`#div_${this.id}`).slideToggle('fast')
    });
    addAssayTypeOptions()

    $j('#addSubSample').on("click", () => {
      let options = {
        title: 'sub-sample of',
        tableClass: '.tbl_response_variables',
        bias: 2,
      }
      addColumn(options)
    })
  })



  //-----------------------------------------------------------------
  async function SAVE() {
    let flowchartData = $j('#chart_canvas').flowchart('getData');
    //console.log(flowchartData);
    // return

    // $j.map(flowchartData.operators, (v, index) => {
    //   console.log(v.properties.shape_id)
    // })
    if (validateWorkflow(flowchartData) == false) return
    const res = await getStudyAssays()
    let oldAssays = JSON.parse(res.assays)
    let oldSamples = JSON.parse(res.samples)
    if (!$j.isArray(oldSamples))
      oldSamples = [oldSamples]
    let newSamples = extractSamples(flowchartData);
    newSamples = compareAndUpdateSamples(oldSamples, newSamples)
    // If there is already a sample source in DB, keep content and just change the id and the name with the new one
    newSamples = checkSampleSource(newSamples)
    let oldMethods = getOldMethods(res)
    let methodNameIds = extractMethods(flowchartData)
    let newMethods = methodNameIds.methods
    let toBeRemovedAssays = ToBeRemovedAssays(oldMethods, methodNameIds.methodsId)
    $j.when.apply($j, toBeRemovedAssays).then(() => {
      let oldMethodsIds = $j.map(oldMethods, (value, index) => {
        return value.id
      });
      let toBeCreatedAssays = [],
        newAssays = []
      $j.each(methodNameIds.methodsId, (i, v) => {
        if ($j.inArray(v, oldMethodsIds) == -1) {
          let assayDetail = getAssayDetail(methodNameIds.opId[i])
          toBeCreatedAssays.push(createAssay(pid, $j("#selected_item_id").val(), uid,
            assayDetail.title, assayDetail.description))
          newAssays.push(genAssayStruct(newMethods[i]))

        }
      });
      $j.when.apply($j, toBeCreatedAssays)
        .then((res) => {
          // Pass newSamples also , their ID should be set coz tabes are inside methods NOW!!
          let tempVal = updateAssaysId(newAssays, toBeCreatedAssays, newSamples)
          newAssays = tempVal.assays
          newSamples = tempVal.samples
          newAssays = compareAndUpdateAssays(oldAssays, newAssays, methodNameIds)
          setOperatorId(flowchartData, newSamples, newAssays)
          $j.each(newAssays, (i, v) => {
            let conSamples = connectedSamples(newAssays[i].method.title, flowchartData)
            newAssays[i].in_id = getSampleId(conSamples.input, newSamples)
            newAssays[i].out_id = getSampleId(conSamples.output, newSamples)
          })
          // Apply new columns from attributes
          newSamples = applyAttributes(newAssays, newSamples)
          //Sample structure : {data:[], samples:[newSamples]}
          save_flowchart(flowchartData, newAssays, newSamples)
          location.reload(true);
        })
    })
  }

  function applyAttributes(assays, samples) {
    // We have to handle all the samples
    // Check if they have the attributes currently or not
    $j.each(assays, (k, v) => {
      let sampleId = v.id // assay and sample id are the same
      let typeId = v.method.type
      let needUpdate = false
      //find the sample
      let sample, sampleIndex

      $j.each(samples, (k, v) => {
        if (v.id == sampleId) {
          sample = v
          sampleIndex = k
          return false
        }
      })

      if (sample == undefined) return true
      let sampleContent = sample.content
      // Try parse
      sampleContent = TryJsonParse(sampleContent)

      if (!sampleContent) {
        sampleContent = {};
        needUpdate = true
      }
      // Insert ID Column
      if (!sampleContent.id) {
        sampleContent["id"] = '';
        needUpdate = true
      }

      //check if it has the attributes currently
      if (JSON.stringify(sampleContent).indexOf("attribute-") == -1) // attribute-colName
      {
        needUpdate = true
        //Aquire the list of the attributes
        let cols = methodTypes[typeId].attributes
        // Append to the content
        $j.each(cols, (k, v) => {
          sampleContent[`${v.title}%attribute-${v.title}`] = ""
        })
      } else {
        // just skip
      }
      if (needUpdate) {
        let tmp = $j.isArray(sampleContent) ? sampleContent : [sampleContent];
        samples[sampleIndex].content = JSON.stringify(tmp)
      }
    })
    console.log("samples");

    console.log(samples);

    return samples
  }

  function genAssayStruct(title) {
    return {
      "id": "x",
      "title": "y",
      "method": {
        title,
        "content": ""
      },
      "in_id": "",
      "out_id": ""
    }
  }

  function getStudyAssays(std_id) {
    std_id = std_id || $j("#selected_item_id").val()
    return $j.ajax({
      method: 'GET',
      cache: false,
      url: `/projects/${pid}/study_assays?std_id=${std_id}`
    })
  }

  function getOldMethods(data) {
    return $j.map(JSON.parse(data.assays), i => {
      return {
        "id": i.id,
        "title": i.method.title
      }
    })
  }

  function ToBeRemovedAssays(OldMethods, newMethods) {
    let arr = []
    $j.each(OldMethods, (i, item) => {
      if ($j.inArray(item.id, newMethods) == -1) {
        arr.push(removeAssay(item.id))
      }
    })
    return arr
  }

  function updateAssaysId(assays, arr, samples) {
    let sampleLength = samples.length
    let assayLength = assays.length
    let cnt = sampleLength - assayLength
    for (var i = 0; i < arr.length; i++) {
      let id = JSON.parse(arr[i].responseText).data.id
      assays[i].id = id
      assays[i].title = JSON.parse(arr[i].responseText).data.attributes.title
      samples[cnt + i].id = samples[cnt + i].id == "?" ? id : samples[cnt + i].id
    }
    return {
      'assays': assays,
      'samples': samples
    }
  }

  function setOperatorId(data, samples, assays) {
    $j.map(data.operators, (operator, index) => {
      $j.each(samples, (i, val) => {
        if (val.title == operator.properties.title) {
          operator.properties.shape_id = val.id
        }
      })
      $j.each(assays, (i, val) => {
        if (val.method.title == operator.properties.title) {
          operator.properties.shape_id = val.id
        }
      })
    })
  }


  function compareAndUpdateAssays(old, New, FLMethods) {
    let temp = []
    let exist = false
    $j.each(FLMethods.methodsId, (k, v) => {
      for (let i = 0; i < old.length; i++) {
        if (old[i].id == v) {
          old[i].method.title = FLMethods.methods[k]
          temp.push(old[i])
          break;
        }
      }
    })
    for (let i = 0; i < New.length; i++) {
      //Syncing the method types
      New[i].method["type"] = AssayDetails[i].methodType
      temp.push(New[i])
    }
    return temp
  }

  function compareAndUpdateSamples(old, New) {
    // New contains all samples
    if (New.length == 0) return [] //old
    for (let j = 0; j < New.length; j++) {
      for (let i = 0; i < old.length; i++) {
        if (old[i].id == New[j].id) {
          New[j].title = old[i].title // If exist just update the title
          New[j].content = old[i].content
          break;
        }
      }
    }
    return New

  }
  //-----------------------------------------------------------------


  function removeAssay(assayId) {
    return $j.ajax({
      method: 'DELETE',
      "headers": {
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      cache: false,
      url: `/assays/${assayId}`,
      success: s => {
        console.log(`assay ${assayId} deleted!`)
      },
      error: (e) => {
        console.log(`error deleting assay ${assayId}!`)
      }
    })
  }

  function createAssay(pid, std_id, uid, title, desc) {
    let data = {
      "data": {
        "type": "assays",
        "attributes": {
          "title": title,
          "description": desc,
          "assay_class": {
            "key": "EXP"
          },
          "policy": {
            "access": "download",
            "permissions": [{
              "resource": {
                "id": pid,
                "type": "projects"
              },
              "access": "manage"
            }]
          }
        },
        "relationships": {
          "study": {
            "data": {
              "id": std_id,
              "type": "studies"
            }
          },
          "creators": {
            "data": [{
              "id": uid,
              "type": "people"
            }]
          }
        }
      }
    }

    return $j.ajax({
      method: 'POST',
      "headers": {
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      cache: false,
      url: '/assays',
      data: JSON.stringify(data),
      success: s => {
        console.log('assay was created successfully! : ' + s.data.id)
        s.data.id
      },
      error: (e) => {
        console.log('error create assay!')
      }
    })
  }


  function hide_all_containers() {
    $j("#projectDetailContainer").hide()
    $j("#fileManagerContainer").hide()
    $j("#investigationContainer").hide()
    $j("#studyContainer").hide()
    $j("#assayContainer").hide()
    // $j("#text_content").hide()
    // $j("#tbl_file_content").hide()
    $j("#separator_item").hide()
  }

  $j('#html').on('changed.jstree', function (e, data) {
      let item = data.instance.get_node(data.selected[0])
      let item_id = item.original._id
      let item_type = item.original._type
      $j("#selected_item_type").val(item_type)
      $j("#selected_item_id").val(item_id)
      $j("#selected_tree_item_id").val(item.id)
      hide_all_containers();
      switch (item_type) {
        case "prj":
          $j("#projectDetailContainer").show()
          breadcrumb("prj")
          break;
        case "inv":
          $j("#investigationContainer").show()
          inv_id = item_id
          populate_tags(item_id, 'inv')
          breadcrumb("inv")
          break;
        case "std":
          $j("#studyContainer").show()
          std_id = item_id
          populate_tags(item_id, 'std')
          breadcrumb("std")
          load_design();
          loadSamplesSourceTable(std_id); // for the tbl_sample_source
          loadSuggestedCols(item_id)
          break;
        case "asy":
          $j("#assayContainer").show()
          std_id = $j(`#${item.parent}`).children('a[_type="std"]').attr("_id")
          asy_id = $j(`#${item.id}`).children('a[_type="asy"]').attr("_id")
          loadMethod(std_id, asy_id)
          loadSuggestedCols(std_id)
          load_design(std_id);
          load_samples(std_id, asy_id)
          breadcrumb("asy")
          get_assay(asy_id)
          loadAssayType(asy_id, std_id)
          break;
        case "fld":
          $j("#fileManagerContainer").show()
          $j("#selected_folder").val(item.text)
          $j("#separator_item").show()
          load_files()
          break;
      }
    })
    .jstree({
      'core': {
        'data': <%= @tree_data.html_safe %>
      },
      plugins: ["separate"]
    });

async function loadAssayType(asy_id, std_id){
   let res = await getStudyAssays(std_id), assayType=0
   res = JSON.parse(res.assays)

   $j.each(res, (key, assay)=>{
     if (assay.id == asy_id){
        assayType = assay.method.type
        return false
     }
   })
   $j("#assayTypeTab").html(methodTypes[assayType].title)
    $j.each(methodTypes[assayType].attributes, (k, attr) => {
            $j("#adetailsAttribs").append(`<li>${attr.title}</li>`)
        })
   
}
  function addInvestigations(t) {
    $j('#data-file-modal-inv').modal({
      backdrop: 'static',
      keyboard: true
    });
  }

  function addStudies(t) {
    //Change the JStree active item to the associated Investigation id
    $j("#selected_item_id").val($j(t).parent().children('.jstree-anchor').attr('_id'))
    $j('#data-file-modal-std').modal({
      backdrop: 'static',
      keyboard: true
    });
  }

  function populate_tags(item_id, item_type) {
    //Populate the tags input with list of 'Shared with people'
    let geturl = item_type == 'inv' ? '/investigation_shared_with?inv_id=' : '/study_shared_with?std_id='
    let tag_input = item_type == 'inv' ? '#investigation-permission-people-ids' : '#study-permission-people-ids'
    $j.ajax({
      type: 'GET',
      cache: false,
      url: pid + geturl + item_id,
      success: s => {
        if (s.people)
          $j(tag_input).tagsinput('removeAll');
        s.people.map((person) => {
          $j(tag_input).tagsinput('add', {
            id: person.id,
            name: person.nam
          })
        })
        if (item_type == 'inv') get_investigation()
        else get_study()
      },
      error: e => {
        alert("Error retrieving investigation sharing list")
      }
    })
  }

  function get_study() {
    $j.ajax({
      method: 'GET',
      "headers": {
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      cache: false,
      url: `/studies/${$j("#selected_item_id").val()}`,
      success: s => {
        $j('#studytitleContent').text(s.data.attributes.title)
        $j('#StudyDescriptionContent').text(s.data.attributes.description)
        $j('#experimentalists').text(s.data.attributes.experimentalists)
      },
      error: (e) => {
        console.log('error gettign study!')
      }
    })
  }

  function get_investigation() {
    $j.ajax({
      method: 'GET',
      "headers": {
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      cache: false,
      url: `/investigations/${$j("#selected_item_id").val()}`,
      success: s => {
        $j('#investigationTitleC').text(s.data.attributes.title)
        $j('#investigationDesC').text(s.data.attributes.description)
      },
      error: (e) => {
        console.log('error gettign investigation!')
      }
    })
  }

  function get_project() {
    $j.ajax({
      method: 'GET',
      "headers": {
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      cache: false,
      url: `/projects/${pid}`,
      success: s => {
        $j('#projectTitleC').text(s.data.attributes.title)
        $j('#projectDesC').text(s.data.attributes.description)
      },
      error: (e) => {
        console.log('error gettign project!')
      }
    })
  }

  function get_assay(assayId) {
    $j.ajax({
      method: 'GET',
      "headers": {
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      cache: false,
      url: `/assays/${assayId}`,
      success: s => {
        $j('#assaytitleContent').text(s.data.attributes.title)
        $j('#assayDescription').text(s.data.attributes.description)
      },
      error: (e) => {
        console.log('error gettign assay!')
      }
    })
  }

  function uniqId() {
    return Math.round((Math.random() * 36 ** 12)).toString(36);
  }

  function breadcrumb(item) {
    $j(".bcrumb li").hide()
    switch (item) {
      case "prj":
        $j(".bcrumb li:first-child").show()
        break;
      case "inv":
        $j(".bcrumb li:first-child, li:nth-child(2)").show()
        break;
      case "std":
        $j(".bcrumb li:first-child, li:nth-child(2), li:nth-child(3)").show()
        break;
      case "asy":
        $j(".bcrumb li:first-child, li:nth-child(2), li:nth-child(3), li:nth-child(4)").show()
        break;
    }
  }

  function deleteItem() {

    if (confirm('Are you sure you want to delete the')) {
      let id = $j("#selected_item_id").val();
      let itemType = "unknown"
      switch ($j("#selected_item_type").val()) {
        case "prj":
          itemType = "projects";
          break;
        case "inv":
          itemType = "investigations";
          break;
        case "std":
          itemType = "studies";
          break;
        case "asy":
          itemType = "assays";
          break;
        default:
          itemType = "unknown";
      }
      if (!id || itemType == "unknown") {
        alert("Please select item.")
        return;
      }
      $j.ajax({
        method: 'DELETE',
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        cache: false,
        url: `/${itemType}/${id}`,
        success: s => {
          alert("Item was deleted successfully!")
          location.reload(true);
        },
        error: e => {
          if (e.responseJSON.errors)
            alert(e.responseJSON.errors[0].title + '\n' + e.responseJSON.errors[0].details)
          else
            alert('Cannot process the request')
        }
      })
    } else {

    }
  }

  function checkSampleSource(samples) {
    $j.ajax({
      method: 'GET',
      cache: false,
      url: pid + '/all_samples',
      data: {
        'std_id': $j("#selected_item_id").val()
      },
      success: s => {
        if (s.data && s.data.length == 0) {
          samples[0].content = s.data.content
        }
      }
    })
    return samples
  }

  function getAssayDetail(opId) {
    for (let i = 0; i < AssayDetails.length; i++) {
      if (AssayDetails[i].opId == opId) {
        return AssayDetails[i]
      }
    }
  }

  function TryJsonParse(str) {
    let json = ''
    try {
      json = JSON.parse(str);
    } catch (e) {
      return false;
    }
    return json;
  }
</script>